require(["jquery"], function ($) {
    CorraUI.init({
        desktop: 1001,
        tablet: 999,
        mobile: 767
    });









    
    var lifestyleSlider;
    var lifeStyleHeaderSlider;
    var xhr;
    var initLifeStyleDynamicSlider = function() {
        var $sliderContainer = $('.lifestyle-outer');
        var $sliderHeadSwitch = $('<div/>', {"id": 'lifestyle-slider-header-switch', "class": 'lifestyle-slider-header-switch owl-carousel'});
        var $sliderContainerDiv = $('<div/>', {"class": "life-style-slider-container owl-carousel"});
        jQuery.each(lifestyle, function(i, item) {
            $('<div/>', {"class": 'lifestyle-slider-header-item', "data-sliderindex": i}
                            ).on('click', function() {
                                if(!CorraUI.isMobile()) {
                                    lifestyleSlider.trigger('to.owl.carousel', [i])
//                                    lifestyleSlider = createLifeStyleSlider(i);
                                    createLifestyleAJAXSKUPost(i, 1);
                                    $(this).parent().parent().find('.current-slider').removeClass('current-slider');
                                    $(this).addClass("current-slider");
                                }
                                
                            }).append($('<span/>', {"text": item.lifestyle_name})).appendTo($sliderHeadSwitch);
                            
            var sliderImage = item.slider_images[1]               
            var $contentDiv = $('<div/>', {"class": "lifestyle-slider-content-item"});
            $contentDiv.attr('index', i);
            if(sliderImage.URL1X) {
              var image_data = {"data-src": sliderImage.URL1X, "srcset": sliderImage.URL + " 1.3x"};
            }
            else {
              var image_data = {"data-src": sliderImage.URL};
            }
            image_data.class = 'custom-lazy';

            var image = $('<img/>', image_data);
            if (sliderImage.link){
                image = $('<a/>').attr('href', sliderImage.link).append(image);
            }
            if (sliderImage.label){
                image.append('<span class="lifestyle-slider-content-item-title">' + sliderImage.label + '</span>');
            }
            image.appendTo($contentDiv);
            $contentDiv.appendTo($sliderContainerDiv);
        });
        
        if (!CorraUI.isMobile()){
            $sliderHeadSwitch.append('<div><span></span></div>');
        }

        $sliderHeadSwitch.appendTo($sliderContainer);
        $sliderContainerDiv.appendTo($sliderContainer);

        if ('IntersectionObserver' in window) {
            var observer = new IntersectionObserver(
                function(entries, observer) { 

                    if (!entries[0].isIntersecting) return;

                    $sliderContainer.find('.custom-lazy:not(src)').each(function(){
                        var element = $(this);
                        element.attr('src', element.attr('data-src'));
                        element.attr('processed', true);
                        element.addClass('loaded');
                    });
                    observer.unobserve(entries[0].target);
                }, 
                {rootMargin: "0px 0px -200px 0px"});

            observer.observe($sliderContainer.get(0));
        }

        lifeStyleHeaderSlider = $sliderHeadSwitch.owlCarousel({
                "loop": false,
                "navText": ["", ""],
                "responsive": {
                    "0": {
                        "items": 1,
                        "nav": false,
                        "touchDrag": false,
                        "dots": false,
                        "center": true
                    },
                    "767": {
                        "items": 6,
                        "nav": false,
                        "margin": 32,
                        "autoWidth":true,
                        "center": false
                    }
                }

        });
        
        lifestyleSlider = $sliderContainerDiv.owlCarousel({
                "items": 1,
                "nav": true,
                "center": true,
                "loop": true,
                "navText": ["", ""],
                "dots": false,
                "stagePadding": 0,
                "responsiveClass": true,
                "responsive": {
                    "0": {
                        "margin":10,
                        "stagePadding": 22
                    },
                    "767": {
                        "margin":30,
                        "stagePadding": 80
                    },
                    "1024": {
                        "margin":60,
                        "stagePadding": 100
                    }
                }

        });

        lifestyleSlider.on('dragged.owl.carousel', function(event){

            if (!CorraUI.isMobile()) return;

            responsiveSwitch();
            // Fixing index issue in slider.

            var pos = $(event.currentTarget).find('.active .lifestyle-slider-content-item').attr('index');

            if (!CorraUI.isMobile()) {

                $sliderHeadSwitch.find('.owl-stage .owl-item .current-slider').removeClass('current-slider');
                $sliderHeadSwitch.find('.owl-stage .owl-item > div[data-sliderindex="' + pos + '"]').addClass('current-slider');

            }
            
            lifeStyleHeaderSlider.trigger('to.owl.carousel', [pos])
            createLifestyleAJAXSKUPost(pos, 1);
            responsiveSwitch();

        });
        
        lifestyleSlider.on('translated.owl.carousel', function(event) {

            if (CorraUI.isMobile()) return;

            responsiveSwitch();
            // Fixing index issue in slider.

            var pos = $(event.currentTarget).find('.active .lifestyle-slider-content-item').attr('index');

            if (!CorraUI.isMobile()) {

                $sliderHeadSwitch.find('.owl-stage .owl-item .current-slider').removeClass('current-slider');
                $sliderHeadSwitch.find('.owl-stage .owl-item > div[data-sliderindex="' + pos + '"]').addClass('current-slider');

            }
            
            lifeStyleHeaderSlider.trigger('to.owl.carousel', [pos])
            createLifestyleAJAXSKUPost(pos, 1);
            responsiveSwitch();
            
        });

        $sliderHeadSwitch.on('translated.owl.carousel', function(event) {

            if (CorraUI.isMobile()) return;

            $(event.target).find('.owl-item .active .lifestyle-slider-header-item').addClass('current-slider');
            lifestyleSlider.trigger('to.owl.carousel', [event.page.index])

            var pos = $(event.currentTarget).find('.active .lifestyle-slider-content-item').attr('index');

            createLifestyleAJAXSKUPost(pos, 1);
            responsiveSwitch();
        });
        $('.owl-stage .lifestyle-slider-header-item:first').addClass('current-slider');
//        lifestyleSlider = createLifeStyleSlider(0);
        createLifestyleAJAXSKUPost(0, 1);
    };
    
    var responsiveSwitch = function() {

        if(CorraUI.isMobile()) {
            if($('.lifestyle-ajax-response-container').length) {
                $('#lifestyle-slider-header-switch').insertBefore($('.lifestyle-ajax-response-container'));
            } else {
                $('#lifestyle-slider-header-switch').insertAfter($('.life-style-slider-container'))
            }
            
        } else {
            $('#lifestyle-slider-header-switch').insertBefore($('.life-style-slider-container'));
        }

    };

    var createLifestyleAJAXSKUPost = function(sliderIndex, itemIndex) {
        if(xhr) {
            xhr.abort();
        }
        var $sliderContainer = $('.lifestyle-outer');
        var $htmlContainer = $('<div/>', {"class": "lifestyle-ajax-response-container"});
        var $loaderImage = $('.lifestyle-loader.no-display').clone().removeClass('no-display')
        if ($sliderContainer.find('.lifestyle-ajax-response-container').length) {
            $htmlContainer = $sliderContainer.find('.lifestyle-ajax-response-container')
            $htmlContainer.html("");
            $htmlContainer.addClass('ajax-loading');
            $htmlContainer.html($loaderImage);
        } else {
            $htmlContainer = $('<div/>', {"class": "lifestyle-ajax-response-container"});
            $htmlContainer.append($loaderImage)
        }
        $htmlContainer.insertAfter($('.life-style-slider-container'));

        var currentSliderItem = lifestyle[sliderIndex];

        var sku = currentSliderItem["slider_images"][itemIndex]["skus"]
        
        xhr = $.post("/lifestyle/index/index/", {"skus": sku}, function(response) {
//            if ($sliderContainer.find('.lifestyle-ajax-response-container').length) {
//                $sliderContainer.find('.lifestyle-ajax-response-container')[0].remove();
//            }
            $htmlContainer.removeClass('ajax-loading');
            $loaderImage.hide();
            $htmlContainer.html(response);
            $htmlContainer.trigger('contentUpdated');
//            $htmlContainer.insertAfter($('.life-style-slider-container'));
            responsiveSwitch();
//            setTimeout(function(){
//                updateSwatches();
//            }, 500);
            $('body').trigger('lazyloadRefresh');
            
        })
    };
    
//    var updateSwatches = function() {
//            $('.lifestyle-ajax-response-container').find('.swatch-attribute-options').each(function(index, item) {
//                var itemLink = $(item).parent().parent().parent().prev('a').attr('href');
//                $(item).find('.swatch-option').each(function(i, option) {
//                    if(i > 5) {
//                        $(option).css('display', 'none');
//                        if (!$(option).parent().find('.show-more-option').length) {
//                            $('<span/>', {"class": "show-more-option", "text": "+ more"}).on('click', function() {
//                                  window.location.href = itemLink;
//                            }).appendTo($(option).parent());
//                        }
//                        
//                    }
//                });
//            });
//        };

    $(document).ready(function () {
        if($('.cms-home').length) {
            //initializing owl carousel for social review
            $("#social_reviews_testimonials").owlCarousel({
                        "navText": ["", ""],
                        "nav": true,
                        "dots": false,
                        "loop":false,
                        "responsive": {
                            "0": {
                                items: 1,
                                margin:10
                            },
                            "767": {
                                "items": 2                        
                            }
                        }
           });

            initOwl = function (elem) {
                elem.owlCarousel({
                    "navText": ["", ""],
                    "center": true,
                    "loop": true,
                    "items": 1,
                    "nav": true,
                    "dots": false,
                    "navRewind": false
    //               "responsive": {
    //                 "1024": {
    //                   "nav": true
    //                 }
    //               }
                });
            };

            initOwl($(".lifestyle-slider").eq(0));

            $(".life-style-category-item").click(function () {
                $(".life-style-category-item, .life-style-info-item").removeClass("active");
                var id = $(this).data("id");
                $(this).addClass("active");
                $(".life-style-info-item[data-id='" + id + "']").addClass("active");


                var owlElement = $(".life-style-info-item[data-id='" + id + "']").find(".lifestyle-slider");

                if(! owlElement.hasClass('owl-loaded')) {
                    initOwl(owlElement);    
                }

            });

            if(typeof(lifestyle) === 'undefined') {
                console.log("lifestyle json not found");
            } else {
                initLifeStyleDynamicSlider();
                responsiveSwitch();
            }
        }
        
        $(window).resize(function() {
           responsiveSwitch();
        });

        //Loading @2x and 3x images for spotlight    
        var imgSizeParam = CorraUI.getHighResolutionImageIdentifier();
        var imgUrl = $('.product_spotlight_fullbleed .main_ctn').css('background-image');
        $('.product_spotlight_fullbleed .main_ctn').css('background-image', CorraUI.highResolutionImageHelper(imgUrl, imgSizeParam));
    });
   
});