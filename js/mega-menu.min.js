define([
    'jquery',
    "matchMedia",
    'jquery/ui'

], function ($, mediaCheck) {
    // the widget definition, where "corra" is the namespace,
    // "productFilter" the widget name

    $.widget("corra.megaMenu", {
        options: {
            responsive: false,
            expanded: false
        },
        menu: {},

        _create: function () {
            var self = this;

            this._super();
            $(window).on('resize', function () {
                self.element.find('.submenu-reverse').removeClass('submenu-reverse');
            });
        },

        _init: function () {
            this._super();
   

            if (this.options.expanded === true) {
                this.isExpanded();
            }
            this.menu.firstLevel = $('.navigation > ul > li.level0');
            this.menu.secondLevel = $('.navigation > ul  li.level1');
            this.menu.thirdLevel = $('.navigation ul.level1 li.level2');

            $('.navigation .subcategory-container .menu_base_cms-block').hide();

            var _self = this,
            timeoutID = 0,
            firstLevelTimeout = 100,
            secondLevelTimeout = 300;
            
            if (this.options.responsive === true) {
                mediaCheck({
                    media: '(max-width: 1000px)',
                    entry: $.proxy(function () {
                        _self._closeAllMenus();
                    }, this),
                    exit: $.proxy(function () {
                        _self._closeAllMenus();
                    }, this)
                });
            }


            //Default Category Selection
            $('nav.navigation a[href="' + window.location.href + '"]').closest('li.level0').addClass('active jq-default-category');

            //Check if accordion are present
            $('nav.navigation li.level0, nav.navigation li.level1').each(function (index, item) {

                $(item).find('a').nextAll('ul').length ? $(item).addClass('has-accordion') : $(item).addClass('no-accordion');

            });

            if (CorraUI.isTouch()) {
                $('body').css('cursor','pointer').css('-webkit-tap-highlight-color','transparent');
            }
            
            //Disable click event 
            this.menu.firstLevel.children('a').add(this.menu.secondLevel.children('a')).add(this.menu.thirdLevel).css('cursor', 'pointer')
                    .click(function (e) {

                        e.preventDefault();

                    });


            this.menu.firstLevel.on(($("body").hasClass("touch") ? 'click.megamenu' : 'mouseenter.megamenu'), function (e) {

                if (!CorraUI.checkMediaQuery(1000)) {
                    var $this = $(this);

                    // $(this).children('ul.submenu').show();
                     clearTimeout(timeoutID);
                    timeoutID = setTimeout(function () {
                        _self._showFirstLevelMenu($this);
                        _self._showSecondLevelMenu($this.children('ul.level0.submenu').find('li.level1:not(.view-all-link)').eq(0));
                    }, firstLevelTimeout);
                    
                }

            });

            this.menu.firstLevel.on('mouseleave.megamenu', function (e) {
                if(_self._isDesktopMenu()){
              
                  clearTimeout(timeoutID);
                  timeoutID = setTimeout(function(){
                        _self._closeAllMenus();
                    }, firstLevelTimeout);
                    
                }
                 
            });

            this.menu.firstLevel.add(this.menu.secondLevel).add(this.menu.thirdLevel).on('click.megamenu', function (e) {
                var $this = $(this);

                if (CorraUI.checkMediaQuery(1000) && $this.hasClass('has-accordion')) {
                    _self._toggleAccordion($this);
                } else if ((CorraUI.isTouch() && ($this.hasClass('jq-mouseover') || $this.hasClass('no-accordion'))) || !CorraUI.isTouch() || $this.hasClass('level2')) {
                    window.location.href = $this.children().attr('href');
                }
                return false;
            });

           
            this.menu.secondLevel.on('mouseenter.megamenu', function () {

                if (!CorraUI.checkMediaQuery(1000)) {
                    
                    clearTimeout(timeoutID);
                    
                    var $this = $(this);
                    
                    timeoutID = setTimeout(function () {
                        _self._showSecondLevelMenu($this);
                    }, secondLevelTimeout);


                }

            }).on('mouseleave.megamenu', function () {
                if (!CorraUI.checkMediaQuery(1000)) {
                   
                    var $this = $(this);
                    
                  /*  setTimeout(function(){
                         _self._showSecondLevelMenu($this.siblings('li.first'));
                    },1000)*/
                    clearTimeout(timeoutID);
                    timeoutID = setTimeout(function () {
                        
                        _self._showSecondLevelMenu($this.siblings('li.first'));
                    }, secondLevelTimeout);
                }


            });

            this.menu.thirdLevel.on('mouseenter.megamenu', function () {
                clearTimeout(timeoutID);
            });

            this._assignControls()._listen();

        },
        _isDesktopMenu: function(){
           return  (!CorraUI.checkMediaQuery(1000)) ? true: false;
        },
        _assignControls: function () {
            this.controls = {
                toggleBtn: $('[data-action="toggle-nav"]'),
                swipeArea: $('.nav-sections')
            };

            return this;
        },

        _listen: function () {
            var controls = this.controls;
            var toggle = this.toggle;

            this._on(controls.toggleBtn, {'click': toggle});
            this._on(controls.swipeArea, {'swipeleft': toggle});
        },

        toggle: function () {
            if ($('html').hasClass('nav-open')) {
                $('html').removeClass('nav-open');
                setTimeout(function () {
                    $('html').removeClass('nav-before-open');
                }, 300);
            } else {
                $('html').addClass('nav-before-open');
                setTimeout(function () {
                    $('html').addClass('nav-open');
                }, 42);
            }
        },

        //Add class for expanded option
        isExpanded: function () {
            var subMenus = this.element.find(this.options.menus),
                    expandedMenus = subMenus.find('ul');

            expandedMenus.addClass('expanded');
        },

        _activate: function (event) {
            window.location.href = this.active.find('> a').attr('href');
            this.collapseAll(event);
        },


        _showFirstLevelMenu: function ($this) {
            //  if (CorraUI.isTouch()) {

            $this.find('img.lazyload').each(function(){
                var image = $(this);
                image.attr('src', image.attr('data-src')).removeClass('lazyload');
            });

            $this.addClass('active jq-mouseover').children('ul.level0.submenu').show();
            $this.siblings('li.level0').removeClass('jq-mouseover active');
            $this.siblings('li.level0').children('ul.level0.submenu').hide();
            //}

        },
        _hideSecondLevelMenu: function ($this) {

            var $submenu = $this.closest('ul.level0.submenu');

            $this.siblings('li.level1').removeClass('active jq-mouseover').children('a').css('text-decoration', 'none');


            $this.addClass('active jq-mouseover').children('a').css('text-decoration', 'underline');

            $this.find('ul.level1.submenu').show();
            $submenu.children('.menu_inner_wrapper').children('.menu_base_cms-block').html($this.children('.menu_base_cms-block').html());

            if ($this.hasClass('first')) {
                setTimeout(function () {
                    $this.children('ul.level1.submenu').show();

                }, 500);
            }
        },
        _showSecondLevelMenu: function ($this) {

            var $submenu = $this.closest('ul.level0.submenu');

            $this.siblings('li.level1').removeClass('active jq-mouseover').children('a').css('text-decoration', 'none');
            $this.siblings('li.level1').find('ul.level1.submenu').hide();


            $this.addClass('active jq-mouseover').children('a').css('text-decoration', 'underline');

            $this.find('ul.level1.submenu').show();

            $submenuChild = $submenu.children('.menu_inner_wrapper').children('.menu_base_cms-block').html($this.children('.menu_base_cms-block').html());

            if ($this.hasClass('first')) {
                setTimeout(function () {
                    $this.children('ul.level1.submenu').show();

                }, 500);
            }
        },

        _closeAllMenus: function () {

            var _self = this;
            _self.menu.firstLevel.add(_self.menu.secondLevel).each(function () {

                !$(this).hasClass('jq-default-category') ? $(this).removeClass('active') : $(this).addClass('active');
                $(this).removeClass('jq-mouseover').find('ul.level0.submenu, ul.level1.submenu').hide().removeClass('active');
                $(this).children('a').removeClass('ui-state-active active');


            });



        },
        _toggleAccordion: function ($target) {
            var _self = this;
            if ($target.children('a').hasClass('ui-state-active')) {
                _self._hideAccordion($target);
            } else {
                //Show Accordion
                _self._showAccordion($target);
                var $children = $target.children();
                $children.filter('a').addClass('ui-state-active active');

                //Close nested accordions
                _self._hideAccordion($target.children('ul.submenu').find('li.level1.has-accordion'));



                //Close sibling accordions
                _self._hideAccordion($target.siblings('li.has-accordion'));
            }


        },
        _showAccordion: function ($accordion) {
            $accordion.children('a').addClass('ui-state-active active');
            $accordion.children('ul.submenu').addClass('active').show();
        },
        _hideAccordion: function ($accordion) {
            $accordion.children('a').removeClass('ui-state-active active');
            $accordion.children('ul.submenu').removeClass('active').hide();
        }

    });

    return $.corra.megaMenu;
});
