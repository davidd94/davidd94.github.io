require([
    "jquery",
    "Magento_Customer/js/customer-data"
], function($, customerData) {

    CorraUI.init({
        desktop: 1001,
        tablet: 999,
        mobile: 767
    });

    var isSmallScreenPromoBlockReplaced = false;
    var storeDiv = $('.showroom-top-block ul');
    var storeContents = "";
    var focusInput = true;
    //var menuHighlightCleared = false;
    var promoBlockHeight = $('.header-promo-block').height();

    // Function show and hide sticky nave.
    var stickyNav = function() {
        if (!CorraUI.isPolywood()) return;

        var $body = $("body");
        if (Math.round(window.scrollY) > promoBlockHeight) {
            $body.addClass("sticky-nav");
        } else {
            $body.removeClass("sticky-nav");
        }
    };

    var plpBanner = function(){
         var bodyElem = $("body");
         var content = $('.category-view .category-image').length
        if (content && typeof content != 'undefined') {
            bodyElem.addClass("plp-banner");
        } else {
            bodyElem.removeClass("plp-banner");
        }
        
    };

    var arrowPos = function(){
        var bottomVal = 0;
        if(CorraUI.isDesktop()){
        bottomVal = $(window).height() - ($('.header.content').height()/2 - 15);
        } else {
        bottomVal = $(window).height() - ($('.header.content').height() + 55);
        }
        $('.arrow.bounce').css("top",bottomVal);
    };

    var menuMouseLeave = function(){
         if (checkMediaQuery(1023)) {
            return false
        }
        $(".menu-active").removeClass("menu-active");
        $("ul.level0:visible").find("li.level1:first").addClass("menu-active");
        $("ul.level0:visible").find("li.level1:first a:first").css("text-decoration", "underline");
        $("ul.level0:visible").find("li.level1:first ul.level1.submenu:first").show().find("li.level2:first").addClass("menu-active");
        $('ul.level0:visible').find('.menu_base_cms-block:first').empty();
        var imageBlock , imageContent = '';
        imageBlock = $('ul.level0:visible').find('.menu_base_cms-block:first');
        imageContent = $("ul.level0:visible").find('li.level1:first').show().find('.menu_base_cms-block:first').show();
        if(typeof imageContent.html() != 'undefined'){
            imageContent = imageContent.clone(true,true);
            imageBlock.replaceWith(imageContent);
            $("ul.level0:visible").find('li.level1:first').show().find('.menu_base_cms-block:first').hide();
       }
    };
    

    // Enbling Footer accordion when mobile menu,
    // and disable when desktop view.
    var setFooterAccordion = function() {
        var config = {
            animate: {
                easing: 'swing',
                duration: 350
            },
            collapsible: true,
            active: [],
            openedState: 'active',
            multipleCollapsible: true
        };

        var $footerContent = $('.footer-links');
        if (CorraUI.isMobile() || CorraUI.isTablet()) {
            $footerContent.accordion(config);
        } else {
            if (typeof $footerContent.data('mageAccordion') !== 'undefined') {
                $footerContent.accordion('destroy').find('[data-role="content"]').show();
            }
        }
    };

    // Function to enable uniform js.
    var initializeUniformJs = function() {
        var uniformSelector = jQuery("input:checkbox, input:radio").not('.no-uniform').not("input[name^='ratings']");
        setTimeout(function(){
        uniformSelector.uniform({
            selectAutoWidth: false
        });
        },500);
        uniformSelector.change(function() {
            jQuery.uniform.update();
        });
    };

    var hideCartUpArrow = function() {
        $upButton = $('#jq-scroll-up');
        $upButton.addClass('hide-up-arrow');
        if ($('li.product-item.show').first().prev().is('li')) {
            $upButton.removeClass('hide-up-arrow');
        }
    };

    var hideCartDownArrow = function() {
        $downButton = $('#jq-scroll-down');
        $downButton.parent().addClass('hide-down-arrow');
        if ($('li.product-item.show').last().next().is('li')) {
            $downButton.parent().removeClass('hide-down-arrow');
        }
    };

    var miniCartScrollEnbling = function() {
        $("#jq-scroll-up").unbind("click").on("click", function() {
            var $lastVisibleItems = $('li.product-item.show');
            var $firstVisibleItem = $lastVisibleItems.first();


            if ($firstVisibleItem.prev().is('li')) {
                $lastVisibleItems.addClass('hide');
                $lastVisibleItems.removeClass('show');

                $firstVisibleItem.prevAll(':lt(3)').addClass('show');
                $firstVisibleItem.prevAll(':lt(3)').removeClass('hide');
            }

            hideCartUpArrow();
            hideCartDownArrow();

        });

        $("#jq-scroll-down").unbind("click").on("click", function() {
            var $lastVisibleItems = $('li.product-item.show');
            var $lastVisibleItem = $lastVisibleItems.last();

            if ($lastVisibleItem.next().is('li')) {
                $lastVisibleItems.addClass('hide');
                $lastVisibleItems.removeClass('show');

                $lastVisibleItem.nextAll(':lt(3)').addClass('show');
                $lastVisibleItem.nextAll(':lt(3)').removeClass('hide');
            }

            hideCartDownArrow();
            hideCartUpArrow();

        });
    };

    var enableVideoOverlay = function() {
        $(document).delegate('.origin_video_block a', 'click', function(e) {
            e.preventDefault();
            $this = $(this);
            var videoURL = $this.attr("href");
            if (videoURL !== '') {
                var iframeTag = '<div class="jq-embed-video-iframe"><div class="iframe-wrapper"><iframe src="' + (videoURL) + '?autoplay=1&rel=0" frameborder="0" allowfullscreen></iframe><a class="video-close" href="javascript:;">close</a></div><div class="overlay">&nbsp;</div></div>';
                $(iframeTag).appendTo('body');

            }
        });

        $(document).delegate('.video-close', 'click', function() {
            $(".jq-embed-video-iframe").remove();
        });
    };

    var menuHovering = function() {
        var CLASS_NAME = 'header-hover';
        if (CorraUI.isDesktop() && !CorraUI.isTouch()) {
            $('.page-header').unbind("mouseover mouseleave").on('mouseover', function() {
                var $this = $(this);
                $this.removeClass(CLASS_NAME);
                $this.addClass(CLASS_NAME);
            }).on('mouseleave', function() {
                var $this = $(this);
                setTimeout(function() {
                    $this.removeClass(CLASS_NAME);
                }, 300);
            });
        }
    };

    var setHeaderPromoReplacements = function() {
        var isSmallScreen = true;
        isSmallScreen = !CorraUI.isDesktop();

        //only do this on polywood
        if (!CorraUI.isPolywood()) return;

        var $promoWrapper = $('.page-header .panel.wrapper'),
            $pageHeader = $('.page-header'),
            $headerContent = $('.header.content');


        /*
        if (isSmallScreen && CorraUI.isPolywood()) {
            if (!isSmallScreenPromoBlockReplaced) {
                $pageHeader.remove('.page-header .panel.wrapper');
                $promoWrapper.insertAfter($headerContent);
                isSmallScreenPromoBlockReplaced = true;
                $('.panel.header').show();
            }

        } else {
            if (isSmallScreenPromoBlockReplaced) {
                $pageHeader.remove('.page-header .panel.wrapper');
                $promoWrapper.insertBefore($headerContent);
                isSmallScreenPromoBlockReplaced = false;
                $('.panel.header').show();
            }
        }
        */
    };


    var cloneLogoToSideNav = function() {
        var logoClone = $('.header.content .logo').clone(true, true);
        var navSections = $('.section-items.nav-sections-items');
        
        if (CorraUI.checkMediaQuery(999)) {
            if (!navSections.find('.logo').length) {
                navSections.prepend(logoClone);
            }
        } else {
            navSections.find('.logo').remove();
            setTimeout(function(){
                navSections.find('.logo').remove();
            },1000);
        }
    };

    var replaceAccountShowroom = function() {
        var $showroom = $('.showroom-link'),
            $account = $('.account-nav register');
        if (CorraUI.isMobile()) {
            if (!$('.section-items.nav-sections-items').find('.showroom-link').length) {
                $('.showroom-link').insertAfter($('.section-item-content.nav-sections-item-content:first'));
                $('.account-nav .register').insertAfter($('.section-item-content.nav-sections-item-content:first').next());
            }
        } else {
            if (!$('.minilinks').find('.showroom-link').length) {
                //                $('.minilinks').prepend($('.account-nav'));
                $('.account-nav .title').append($('.jqAccountLink.register'));
                $('.minilinks').prepend($('.showroom-link'));
            }
        }

    };

    var replaceLogoutButton = function() {
        var $logoutButton = $('.account-nav .header-links .nav.item.login:last a');
        var $supportText = $('.support-block');
        //        $myAccountButton = $('.account-nav .header-links .nav.item:first a');
        if (CorraUI.isDesktop()) {
            $('.logout-mobile-replace').remove();
            $('.support-block.support-block-mobile-replace').insertAfter($('.header-promo-block p'));
            //            $('.myaccount-mobile-replace').remove();
        } else {
            $('.logout-mobile-replace').remove();

           // $logoutButton.clone().addClass('logout-mobile-replace').insertAfter($('.section-item-content.nav-sections-item-content:first').next().next());
            //            $('.section-item-content.nav-sections-item-content:first').next().next().next().next('div').remove();
            $supportText.addClass('support-block-mobile-replace').insertAfter($('.section-item-content.nav-sections-item-content:first').next().next().next());
        }
    };

    var setSupportNumber = function() {
        if (typeof(supportTimingJSON) !== "undefined") {
            var timezone = new Date().toString().match(/\(([A-Za-z\s].*)\)/)[1];
            $('#support-timing').html(supportTimingJSON[timezone.toLowerCase()]);
        }
    };


    var getLocation = function() {
        //check location access saved to local storage has past expiration date
        if (localStorage.getItem('locAccess')){
            var locationSet = localStorage.getItem('locAccess');
            if (locationSet < new Date()) {
                localStorage.removeItem('locAccess');
                localStorage.removeItem('stores');
                localStorage.removeItem('geoLatLong');
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(findStoreLocator);
                } else {
                    console.log("Geolocation is not supported by this browser.");
                }
            } else{
                storeContents = localStorage.getItem('stores');
                if(CorraUI.isDesktop()){
                $('.showroom-top-block ul').empty().html(storeContents);    
                } else {
                $('.showroom-top-block ul').show().empty().html(storeContents).hide();
                }
            }
        } else {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(findStoreLocator);
            } else {
                console.log("Geolocation is not supported by this browser.");
            }
        }
    };

    var rad = function(x) {
        return x * Math.PI / 180;
    };

    var findStoreLocator = function(position) {

        $.get('/showrooms/retrieve/ajax', {
            lat: position.coords.latitude,
            lng: position.coords.longitude
        }, function(result){
            
            if (result && result.items && result.items.length > 0){

                setClosestLocation(result.items[0]);
                localStorage.setItem('closestLocation', JSON.stringify(result.items[0]));
                $('.use-location').hide();
            }
        });
    };

    var setClosestLocation = function(location){
        $('.showroom-block .location-name').text(location.store_name);
        $('.showroom-block .location-address').text(location.address);
        $('.showroom-block .location-city-state').text(`${location.city}, ${location.state} ${location.zipcode}`);
        $('.showroom-top-block ul').show();
    }

    var enableMiniCartClick = function() {
        if (CorraUI.isMobile() || CorraUI.isTablet()) {
            $('a.showcart').on('click.redirect', function(e) {
                window.location.href = $(this).attr('href');
            });
        } else {
            $('a.showcart').unbind('click.redirect');
        }

    };
    var enableAccountClick = function() {
        if (CorraUI.isMobile() || CorraUI.isTablet()) {
            $('.account-nav').on('click.redirect', function(e) {
                window.location.href = $(this).find('.title a.register').attr('href');
            });
        } else {
            $('.account-nav').unbind('click.redirect');
        }

    };

    var initGTMCustomerAnalytics = function(){

        var customer = customerData.get('customer');
        customer.subscribe(function(){

            var customerObject = customer();
            var dataLayerPush = {
                event: 'loggedInState'
            };

            //is logged in
            if (customerObject.email){
                dataLayerPush.loggedIn   = true;
                dataLayerPush.customerId = customerObject.customer_id;
                dataLayerPush.email      = customerObject.email;
            } else {
                dataLayerPush.loggedIn = false;
            }

            if (window.dataLayer){
                window.dataLayer.push(dataLayerPush);
            } else {
                $(document).on('ga:inited', function(){
                    window.dataLayer.push(dataLayerPush);
                });
            }
        });
    }

    var initGAPromoAnalytics = function(){

        //push promotional banner impressions
        var impressions = [];
        jQuery('.promo').each(function () { 

            var element = jQuery(this);

            impressions.push({	
              'name': element.attr('data-name'),
                'creative': (element.attr('src') ? element.attr('src') : element.attr('data-src')).split('/').pop(),
                'position': element.attr('data-position')
            }); 
        });

        var dataLayerPush = {
            'event': 'promoImpressions',
            'ecommerce': {
                'promoView': {
                    'promotions': impressions
                }
            }
        };

        if (impressions.length){

            if (window.dataLayer){
                window.dataLayer.push(dataLayerPush);
            } else {
                $(document).on('ga:inited', function(){
                    window.dataLayer.push(dataLayerPush);
                });
            }


            //push promotional banner clicks
            var impressionsClick = [];

            jQuery('.promo, .copy_head, .hyperlink, .sub_heading, .copy_content').click(function() {

                jQuery(this).each(function() {
                    impressionsClick.push({
                        'name': jQuery(this).closest('a').find('img').attr('data-name'),
                        'creative': jQuery(this).closest('a').find('img').attr('src').split('/').pop(),
                        'position': jQuery(this).closest('a').find('img').attr('data-position')
                    });
                });
                
                var dataLayerPush = {
                    'event': 'promoClick',
                    'ecommerce': {
                        'promoClick': {
                            'promotions': impressionsClick
                        }
                    }
                };
                console.log(dataLayerPush);

                if (window.dataLayer){
                    window.dataLayer.push(dataLayerPush);
                } else {
                    $(document).on('ga:inited', function(){
                        window.dataLayer.push(dataLayerPush);
                    });
                }

                impressionsClick = [];
            });
        }


    }

    var enableStoreIconClick = function() {
        if (CorraUI.isMobile() || CorraUI.isTablet()) {
            $('.showroom-link').on('click.redirect', function(e) {
                window.location.href = $(this).find('a').attr('href');
            });
        } else {
            $('.showroom-link').unbind('click.redirect');
        }
    };

    var bindCustomerServiceFlyout = function(){

        var flyout = $('.customer-service-flyout .flyout');
        var toggle = $('.customer-service-flyout > .toggle');

        var bind = function(event){
            if ($(event.target).closest('.customer-service-flyout').length == 0){
                hideFlyout(flyout, toggle);
            }
        };

        var hideFlyout = function(flyout, toggle){

            toggle.removeClass('active');
            flyout.slideUp(150);
            $('body').unbind('click', bind);
        }

        var showFlyout = function(flyout, toggle){

            toggle.addClass('active');
            flyout.slideDown(150);

            $('body').bind('click', bind);
        }

        $('.customer-service-flyout > .toggle').click(function(event){

            if (window.innerWidth < 768) return;

            event.stopPropagation();

            if (flyout.is(':visible')){
                hideFlyout(flyout, toggle);
            }
            else {
                showFlyout(flyout, toggle);
            }

        });

    }

    var miniCartInitializing = function() {
//        setTimeout(function() { 
            hideCartDownArrow();
            hideCartUpArrow();
            miniCartScrollEnbling();
//        }, 2000);
        
    };

    if (document.addEventListener) {
        document.addEventListener('minicartupdated', function() {
            miniCartInitializing();
        }, false);
    } else {
        document.attachEvent('minicartupdated', function() {
            miniCartInitializing();
        });
    }

    $(document).ready(function() {
        stickyNav();
        setFooterAccordion();
        menuHovering();
        hideCartDownArrow();
        hideCartUpArrow();
        miniCartScrollEnbling();
        //initializeUniformJs();
        enableVideoOverlay();
        //setHeaderPromoReplacements();
        cloneLogoToSideNav();
        CorraUI.responsiveElements();
        CorraUI.responsiveImage();
        replaceAccountShowroom();
        replaceLogoutButton();
        setSupportNumber();
        enableMiniCartClick();
        enableAccountClick();
        enableStoreIconClick();
        initGTMCustomerAnalytics();
        initGAPromoAnalytics();
       
        plpBanner();
        //arrowPos();
        // Toggling search box
        $(".search-toggle").on("click", function(e) {
            e.preventDefault();
            $("body").toggleClass("search-open");
            if(focusInput) {

                var searchInput = $('#search');
                searchInput.focus();
                var oldVal = searchInput.val();
                searchInput.val('').val(oldVal);
                
            } else {
                $('#search').blur();
            }
            focusInput = !focusInput;
        });

        $('.use-location').click(function(){
            getLocation();
        });

        if (localStorage.getItem('closestLocation') !== null){
            setClosestLocation(JSON.parse(localStorage.getItem('closestLocation')));
            $('.use-location').hide();
        }

        $(document).delegate('.read-more', 'click', function() {
            $(this).parents(".jq-description").addClass("more");
        });

        $(document).delegate('.read-less', 'click', function() {
            $(this).parents(".jq-description").removeClass("more");
        });

        $(document).delegate('.close-panel', 'click', function() {
            $('.panel.header').hide();
        });

        if (CorraUI.isMobile() || CorraUI.isTablet()) {
            $(document).delegate('.faq-content-container .title', 'click', function() {
                var element = $(this);
                var content = element.closest('.faq-content-container').find('.faq-content');

                if (content.is(':visible')){
                    content.slideUp(150);
                    element.removeClass('open');
                } else {
                    content.slideDown(150);
                    element.addClass('open');
                }
            });
        } else {
            $(document).delegate('.read-more-faq', 'click', function() {
                var element = $(this);
                element.parents(".faq-content").children("span").toggle();
                element.toggle();
            });
        }
    });


    $(window).load(function() {
        //initializeUniformJs();
        CorraUI.responsiveElements();
        CorraUI.responsiveImage();
        menuHovering();
        hideCartDownArrow();
        hideCartUpArrow();
        miniCartScrollEnbling();
        plpBanner();
        //bindCustomerServiceFlyout();
        

        
    });

    $(document).ajaxComplete(function() {
        miniCartScrollEnbling();
        hideCartDownArrow();
        hideCartUpArrow();
        setSupportNumber();
        //setTimeout(initializeUniformJs, 500);
        CorraUI.responsiveElements();
        CorraUI.responsiveImage();
        
    });

    $(window).scroll(function() {
        stickyNav();
    });


    $(window).resize(function() {
        stickyNav();
        menuHovering();
        setFooterAccordion();
        //setHeaderPromoReplacements();
        cloneLogoToSideNav();
        replaceAccountShowroom();
        replaceLogoutButton();
        CorraUI.responsiveElements();
        CorraUI.responsiveImage();
        enableMiniCartClick();
        enableAccountClick();
        enableStoreIconClick();
     
        if(!CorraUI.isDesktop()) {
            // Removing menu subcategory underling in small device.
            jQuery("ul.level0").find("li.level1:first a:first").removeAttr('style');
        }
    });
    
    if ($('body').hasClass('checkout-index-index')) {
        var initializeUniformJs = function () {

            $("input:checkbox, input:radio").not('.no-uniform').uniform();
            $.uniform.update();
        };

        $('body').delegate('input,button', 'click', function () {
            initializeUniformJs();
            setTimeout(initializeUniformJs, 3000);
        });
        
        $('body').delegate('select', 'change', function () {
            initializeUniformJs();
            setTimeout(initializeUniformJs, 3000);
        });

        $(document).ajaxSuccess(function () {
            initializeUniformJs();
            setTimeout(initializeUniformJs, 5000);
        });
    }
    if($('body').hasClass('catalog-product-view')) {

        var updateQtyFiled = function(selectedQty) {
            $('.input-text.qty').val(selectedQty);
        }

        $(document).ready(function(){

            var qtyDropDownWrapper = $('.qty-drop-down-wrapper');
            var qtyLabelSpan = qtyDropDownWrapper.find('.qty-label');

            var hideDropdown = function(){
                $('.qty-drop-down-wrapper .qty-dropdown-option-wrapper').removeClass('show');
                $('.qty-drop-down-wrapper').removeClass('drop-down-open');
            }
    
            var showDropdown = function(){
                $('.qty-drop-down-wrapper .qty-dropdown-option-wrapper').addClass('show');
                $('.qty-drop-down-wrapper').addClass('drop-down-open');
            }

            var initClickOutsideHandler = function(){
                $('body').on('click.quantity', function(){

                    if($('.qty-drop-down-wrapper .qty-dropdown-option-wrapper').hasClass('show')) {
                        hideDropdown();
                    }

                    removeClickOutsideHandler();

                });
            }

            var removeClickOutsideHandler = function(){

                $('body').off('click.quantity');

            }

            $('.qty-drop-down-wrapper').on('click', function(e) {

                //if(e.target !== e.currentTarget) return;

                e.stopPropagation();
                
                if($('.qty-drop-down-wrapper .qty-dropdown-option-wrapper').hasClass('show')) {
                    hideDropdown();
                } else {

                    showDropdown();
                    initClickOutsideHandler();

                }
            });

            $('.qty-drop-down-wrapper li.drop-down-item').on('click', function(e) {

                e.stopPropagation();
                var _this = $(this);
                _this.parent().find('li').removeClass('selected-qty');
                _this.addClass("selected-qty");
                qtyLabelSpan.text(_this.data('qty-value'));
                updateQtyFiled(_this.data('qty-value'));
                hideDropdown();

            });

            $('.qty-drop-down').slimScroll({
                height: '198px',
            });
        });

    }
});